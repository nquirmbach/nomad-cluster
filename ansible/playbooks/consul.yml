---
- name: Consul Setup
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    consul_version: "1.16.0"
    datacenter: "dc1"
    # Verwende private IPs fÃ¼r Consul Server-Kommunikation
    server_ips: "{{ groups['nomad_servers'] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | list }}"
    consul_encrypt: "{{ lookup('env', 'CONSUL_ENCRYPT') }}"
  tasks:
    - name: Ensure consul_encrypt is provided
      assert:
        that:
          - consul_encrypt is string
          - consul_encrypt | length > 0
        fail_msg: "CONSUL_ENCRYPT env var must be set to a valid gossip key (e.g. output of 'consul keygen')."

    - name: Download Consul
      get_url:
        url: "https://releases.hashicorp.com/consul/{{ consul_version }}/consul_{{ consul_version }}_linux_amd64.zip"
        dest: "/tmp/consul_{{ consul_version }}_linux_amd64.zip"
        mode: '0644'

    - name: Unzip Consul
      unarchive:
        src: "/tmp/consul_{{ consul_version }}_linux_amd64.zip"
        dest: /usr/local/bin
        remote_src: yes
        mode: '0755'
        owner: root
        group: root

    - name: Create Consul systemd service
      template:
        src: ../templates/consul.service.j2
        dest: /etc/systemd/system/consul.service
        mode: '0644'
        owner: root
        group: root

    - name: Create Consul server config
      template:
        src: ../templates/consul-server.hcl.j2
        dest: /etc/consul.d/consul.hcl
        mode: '0644'
      when: inventory_hostname in groups['nomad_servers']

    - name: Create Consul client config
      template:
        src: ../templates/consul-client.hcl.j2
        dest: /etc/consul.d/consul.hcl
        mode: '0644'
      when: inventory_hostname in groups['nomad_clients']

    - name: Start and enable Consul service
      systemd:
        name: consul
        state: restarted
        enabled: yes
        daemon_reload: yes
